<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>INVOICE/MONEY RECEIPT</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
    .container { max-width: 900px; margin: auto; background: white; padding: 25px; border-radius: 10px; box-shadow: none; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .header img { max-height: 60px; }
    .header .info { text-align: right; }
    h2 { text-align: center; margin-bottom: 10px; }
    .form-row { display: flex; gap: 15px; margin-bottom: 10px; }
    .form-row input, .form-row select { flex: 1; padding: 6px; font-size: 14px; }
    label { font-weight: bold; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
    th.small-cell, td.small-cell { width: 60px; }
    .actions { margin-top: 15px; display: flex; justify-content: space-between; }
    .totals { margin-top: 20px; text-align: right; }
    .totals div { margin: 5px 0; }
    .qr { text-align: center; margin-top: 20px; }
    .no-print { display: inline-block; }
    input[disabled] { background: #f0f0f0; color: #666; }
    td .total-input {
      width: 100%;
      box-sizing: border-box;
      padding: 0;
      margin: 0;
      text-align: center;
      border: none;
      background: transparent;
      font: inherit;
      line-height: inherit;
    }
    @media print {
      .no-print { display: none; }
      select, input { font-size: 11px; padding: 0; border: none; appearance: none; background: none; color: black; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="passwordScreen" style="text-align: center; margin-top: 100px;">
      <h2>Please enter password to access the invoice</h2>
      <input type="password" id="passwordInput" placeholder="Enter password" style="padding: 8px; font-size: 16px;">
      <button onclick="checkPassword()" style="padding: 8px 16px; font-size: 16px;">Submit</button>
    </div>

    <div id="protectedContent" style="display:none;">
      <div class="header">
        <img src="https://i.ibb.co/WNZTWPwv/LOGO-PNG-2025-fab.png" alt="Logo">
        <div class="info">
          <div><strong>G10 EDUCATIONAL PLATFORM </strong></div>
          <div>Jayanagar Charali, Beltola Bazar Road, Guwahati-28, Ph. No.: 9706380357</div>
          <div>Date: <input type="date" id="invoiceDateInput" /></div>
          <div>Invoice No: <span id="invoiceNo">-</span></div>
        </div>
      </div>

      <h2>INVOICE/MONEY RECEIPT</h2>

      <div class="form-row">
        <select id="studentSelect" onchange="handleStudentChange()">
          <option value="">-- STUDENT NAME --</option>
        </select>
<input list="invoiceList" id="invoiceSelect" placeholder="-- Load Invoice No. --" oninput="handleInvoiceInput()" />
<datalist id="invoiceList"></datalist>

      </div>

      <div class="form-row">
        <input type="text" id="studentName" placeholder="Student Name" />
        <input type="text" id="phone" placeholder="Phone Number" />
      </div>
      <div class="form-row">
        <input type="email" id="email" placeholder="Email ID" />
        <input type="text" id="address" placeholder="Address" />
      </div>
      <div class="form-row">
        <select id="studentClass">
          <option>Class 9</option>
          <option>Class 10</option>
          <option>Class 11</option>
          <option>Class 12</option>
          <option>IIT-JEE</option>
          <option>NEET</option>
          <option>CUET</option>
        </select>
      </div>

      <table class="invoice-table" id="invoiceTable" style="display: none;">
        <thead>
          <tr>
            <th colspan="2">Date</th>
            <th rowspan="2">Service Type</th>
            <th rowspan="2">Subject</th>
            <th rowspan="2" class="small-cell">No's/Qnty</th>
            <th rowspan="2" class="small-cell">Rate</th>
            <th rowspan="2">Total</th>
            <th rowspan="2" class="no-print">Action</th>
          </tr>
          <tr><th>From</th><th>To</th></tr>
        </thead>
        <tbody id="billBody"></tbody>
      </table>

      <div class="actions">
        <button onclick="addItem()" class="no-print">+ Add Coaching</button>
        <button onclick="window.print()" class="no-print">üñ®Ô∏è Print Invoice</button>
        <button onclick="saveInvoice()" class="no-print">üíæ Save Invoice</button>
      </div>

      <div class="totals">
        <div id="grandTotal">Total Amount: ‚Çπ0.00</div>
        <div id="amountInWords">Total (in words): Zero Rupees Only</div>
        <div>Amount Paid: ‚Çπ<input type="number" id="amountPaid" value="0" min="0" oninput="calculateTotal()" style="width: 100px;"></div>
        <div id="dueBalance">Due Balance: ‚Çπ0.00</div>
      </div>

      <div class="qr">
        <p style="font-weight:bold; color:green; text-align:left;">Scan the Below QR to Pay the Fee:</p>
        <div id="qrCanvas"></div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
      const invoiceDateInput = document.getElementById("invoiceDateInput");
      invoiceDateInput.valueAsDate = new Date();

      function generateInvoiceNo() {
        return "INV-" + Date.now();
      }

      function handleStudentChange() {
        const name = document.getElementById("studentSelect").value;
        const students = JSON.parse(localStorage.getItem("students") || "{}");
        if (students[name]) {
          const s = students[name];
          document.getElementById("studentName").value = name;
          document.getElementById("phone").value = s.phone;
          document.getElementById("email").value = s.email;
          document.getElementById("address").value = s.address;
          document.getElementById("studentClass").value = s.class;
        } else {
          document.getElementById("studentName").value = name;
        }
        document.getElementById("invoiceNo").textContent = generateInvoiceNo();
      }

function saveInvoice() {
  const name = document.getElementById("studentName").value.trim();
  if (!name) return alert("Enter student name.");

  let invoiceNo = document.getElementById("invoiceNo").textContent;
  if (invoiceNo === "-" || !invoiceNo) {
    invoiceNo = generateInvoiceNo();
    document.getElementById("invoiceNo").textContent = invoiceNo;
  }

  const rows = Array.from(document.querySelectorAll("#billBody tr")).map(row => {
    const from = row.children[0].querySelector("input") ? row.children[0].querySelector("input").value : "";
    const to = row.children[1].querySelector("input") ? row.children[1].querySelector("input").value : "";
    const type = row.children[2].querySelector("select") ? row.children[2].querySelector("select").value : "";
    const subject = row.children[3].querySelector("select") ? row.children[3].querySelector("select").value : "";
    const qtyEl = row.children[4].querySelector("input");
    const rateEl = row.children[5].querySelector("input");
    const totalEl = row.children[6].querySelector("input");

    return {
      from,
      to,
      type,
      subject,
      qty: qtyEl ? qtyEl.value : "",
      rate: rateEl ? rateEl.value : "",
      total: totalEl ? totalEl.value : (row.children[6].textContent || "").trim()
    };
  });

  const invoice = {
    name,
    phone: document.getElementById("phone").value,
    email: document.getElementById("email").value,
    address: document.getElementById("address").value,
    class: document.getElementById("studentClass").value,
    date: invoiceDateInput.value,
    amountPaid: document.getElementById("amountPaid").value,
    rows
  };

  const invoices = JSON.parse(localStorage.getItem("invoices") || "{}");
  invoices[invoiceNo] = invoice;
  localStorage.setItem("invoices", JSON.stringify(invoices));

  const students = JSON.parse(localStorage.getItem("students") || "{}");
  students[name] = { phone: invoice.phone, email: invoice.email, address: invoice.address, class: invoice.class };
  localStorage.setItem("students", JSON.stringify(students));

  // ‚úÖ Refresh dropdown and select the just-saved invoice
  populateDropdowns();
  document.getElementById("invoiceSelect").value = invoiceNo;

  alert("Invoice Saved!");
}


  function populateDropdowns() {
  const students = JSON.parse(localStorage.getItem("students") || "{}");
  const studentSelect = document.getElementById("studentSelect");
  studentSelect.innerHTML = `<option value="">-- STUDENT NAME --</option>`;
  Object.keys(students)
    .sort((a, b) => a.localeCompare(b)) // alphabetical
    .forEach(name => {
      const option = document.createElement("option");
      option.value = name;
      option.textContent = name;
      studentSelect.appendChild(option);
    });

  const invoices = JSON.parse(localStorage.getItem("invoices") || "{}");
const invoiceList = document.getElementById("invoiceList");
invoiceList.innerHTML = "";
Object.keys(invoices)
  .sort((a, b) => {
    const timeA = parseInt(a.replace("INV-", ""), 10);
    const timeB = parseInt(b.replace("INV-", ""), 10);
    return timeB - timeA;
  })
  .forEach(no => {
    const option = document.createElement("option");
    option.value = no;
    invoiceList.appendChild(option);
  });

}
function handleInvoiceInput() {
  const invoiceNo = document.getElementById("invoiceSelect").value.trim();
  if (invoiceNo.startsWith("INV-")) {
    loadInvoiceByNumber(invoiceNo);
  }
}




     function loadInvoiceByNumber(invoiceNoParam) {
  const invoiceNo = invoiceNoParam || document.getElementById("invoiceSelect").value;

        const invoices = JSON.parse(localStorage.getItem("invoices") || "{}");
        const invoice = invoices[invoiceNo];
        if (!invoice) return;

        document.getElementById("studentName").value = invoice.name;
        document.getElementById("phone").value = invoice.phone;
        document.getElementById("email").value = invoice.email;
        document.getElementById("address").value = invoice.address;
        document.getElementById("studentClass").value = invoice.class;
        document.getElementById("invoiceDateInput").value = invoice.date;
        document.getElementById("amountPaid").value = invoice.amountPaid;
        document.getElementById("invoiceNo").textContent = invoiceNo;

        const billBody = document.getElementById("billBody");
        billBody.innerHTML = "";
        document.getElementById("invoiceTable").style.display = "table";

        invoice.rows.forEach(row => {
          const tr = document.createElement("tr");

          const isPrev = row.type === 'Prev. balance';
          const isScholar = row.type === 'Fee Concession';

          tr.innerHTML = `
            <td><input type="date" value="${row.from || ''}"></td>
            <td><input type="date" value="${row.to || ''}"></td>
            <td>
              <select onchange="handleServiceTypeChange(this)">
                <option${row.type === 'Individual Coaching' ? ' selected' : ''}>Individual Coaching</option>
                <option${row.type === 'Home Tuition' ? ' selected' : ''}>Home Tuition</option>
                <option${row.type === 'Group Coaching' ? ' selected' : ''}>Group Coaching</option>
                <option${row.type === 'Dual Coaching' ? ' selected' : ''}>Dual Coaching</option>
                <option${row.type === 'Super Group Coaching' ? ' selected' : ''}>Super Group Coaching</option>
                <option${row.type === 'Demo Class Reg. Fee' ? ' selected' : ''}>Demo Class Reg. Fee</option>
                <option${row.type === 'Admission Fee' ? ' selected' : ''}>Admission Fee</option>
		<option${row.type === 'Study Material' ? ' selected' : ''}>Study Material</option>
                <option${isPrev ? ' selected' : ''}>Prev. balance</option>
                <option${isScholar ? ' selected' : ''}>Fee Concession</option>
              </select>
            </td>
            <td>
              <select>
                <option${row.subject === 'Physics' ? ' selected' : ''}>Physics</option>
                <option${row.subject === 'Chemistry' ? ' selected' : ''}>Chemistry</option>
                <option${row.subject === 'Math' ? ' selected' : ''}>Math</option>
                <option${row.subject === 'Biology' ? ' selected' : ''}>Biology</option>
                <option${row.subject === 'Science' ? ' selected' : ''}>Science</option>
                <option${row.subject === 'Qlfd. Scholarship' ? ' selected' : ''}>Qlfd. Scholarship</option>
              </select>
            </td>
            <td></td>
            <td></td>
            <td class="item-total"></td>
            <td class="no-print"><button onclick="this.closest('tr').remove();calculateTotal()">Delete</button></td>
          `;

          billBody.appendChild(tr);

          const qtyCell = tr.children[4];
          const rateCell = tr.children[5];
          const totalCell = tr.children[6];
          const fromInput = tr.children[0].querySelector("input");
          const toInput = tr.children[1].querySelector("input");

          if (isPrev || isScholar) {
            qtyCell.innerHTML = `<input type="text" value="NA" disabled style="width:60px;">`;
            rateCell.innerHTML = `<input type="text" value="NA" disabled style="width:80px;">`;
            const savedTotal = row.total !== undefined ? row.total : "0";
            totalCell.innerHTML = `<input type="number" step="0.01" value="${savedTotal}" class="total-input" oninput="calculateTotal()">`;
            if (isScholar) {
              fromInput.value = "";
              toInput.value = "";
              fromInput.disabled = true;
              toInput.disabled = true;
            }
          } else {
            qtyCell.innerHTML = `<input type="text" value="${row.qty || '1 Cl.'}" style="width:60px;" oninput="calculateTotal()">`;
            rateCell.innerHTML = `<input type="number" value="${row.rate || 0}" min="0" class="rate" style="width:80px;" oninput="calculateTotal()">`;
            const computed = (parseFloat(row.qty) || 0) * (parseFloat(row.rate) || 0);
            totalCell.textContent = Number(computed).toFixed(2);
          }
          handleServiceTypeChange(tr.querySelector("select"));
        });

        calculateTotal();
      }

      function addItem() {
        document.getElementById("invoiceTable").style.display = "table";
        const row = document.createElement("tr");
        row.innerHTML = `
          <td><input type="date"></td>
          <td><input type="date"></td>
          <td>
            <select onchange="handleServiceTypeChange(this)">
              <option>Individual Coaching</option>
              <option>Home Tuition</option>
              <option>Group Coaching</option>
              <option>Dual Coaching</option>
              <option>Super Group Coaching</option>
              <option>Demo Class Reg. Fee</option>
              <option>Admission Fee</option>
		<option>Study Material</option>
              <option>Prev. balance</option>
              <option>Fee Concession</option>
            </select>
          </td>
          <td>
            <select>
              <option>Physics</option>
              <option>Chemistry</option>
              <option>Math</option>
              <option>Biology</option>
              <option>Science</option>
              <option>Qlfd. Scholarship</option>
            </select>
          </td>
          <td><input type="text" value="1 Class" style="width: 60px;" oninput="calculateTotal()"></td>
          <td><input type="number" value="1000" min="0" class="rate" style="width: 80px;" oninput="calculateTotal()"></td>
          <td class="item-total">1000.00</td>
          <td class="no-print"><button onclick="this.closest('tr').remove();calculateTotal()">Delete</button></td>
        `;
        document.getElementById("billBody").appendChild(row);
        calculateTotal();
      }

function handleServiceTypeChange(selectEl) {
  const row = selectEl.closest("tr");
  const qtyCell = row.children[4];
  const rateCell = row.children[5];
  const totalCell = row.children[6];
  const fromInput = row.children[0].querySelector("input");
  const toInput = row.children[1].querySelector("input");

  const val = selectEl.value;

  if (val === "Prev. balance" || val === "Fee Concession") {
    qtyCell.innerHTML = `<input type="text" value="NA" disabled style="width:60px;">`;
    rateCell.innerHTML = `<input type="text" value="NA" disabled style="width:80px;">`;
    const existing = totalCell.querySelector("input") ? totalCell.querySelector("input").value : (totalCell.textContent || "0");
    totalCell.innerHTML = `<input type="number" step="0.01" value="${existing}" class="total-input" style="text-align:center;" oninput="calculateTotal()">`;

    if (val === "Fee Concession") {
      fromInput.value = "";
      toInput.value = "";
      fromInput.disabled = true;
      toInput.disabled = true;
    } else {
      fromInput.disabled = false;
      toInput.disabled = false;
    }
  }
  else if (val === "Study Material") {
    // Quantity shows "1 Qnty" instead of "1 Class"
    qtyCell.innerHTML = `<input type="text" value="1 Qnty" style="width:60px;" oninput="calculateTotal()">`;
    rateCell.innerHTML = `<input type="number" value="0" min="0" class="rate" style="width:80px;" oninput="calculateTotal()">`;
    fromInput.disabled = false;
    toInput.disabled = false;
    if (!fromInput.value) fromInput.value = invoiceDateInput.value || '';
    totalCell.textContent = "0.00";
  }
  else {
    const qtyVal = (qtyCell.querySelector("input") && !qtyCell.querySelector("input").disabled) ? qtyCell.querySelector("input").value : 1;
    const rateVal = (rateCell.querySelector("input") && !rateCell.querySelector("input").disabled) ? rateCell.querySelector("input").value : 0;
    qtyCell.innerHTML = `<input type="number" value="${qtyVal || 0}" min="0" style="width:60px;" oninput="calculateTotal()">`;
    rateCell.innerHTML = `<input type="number" value="${rateVal || 0}" min="0" class="rate" style="width:80px;" oninput="calculateTotal()">`;
    fromInput.disabled = false;
    toInput.disabled = false;
    if (!fromInput.value) fromInput.value = invoiceDateInput.value || '';
    const qtyNum = parseFloat(qtyVal) || 0;
    const rateNum = parseFloat(rateVal) || 0;
    totalCell.textContent = (qtyNum * rateNum).toFixed(2);
  }

  calculateTotal();
}


      // --- calculate grand totals & QR ---
      function calculateTotal() {
        let grandTotal = 0;
        document.querySelectorAll("#billBody tr").forEach(row => {
          const serviceType = row.children[2].querySelector("select").value;
          if (serviceType === "Prev. balance" || serviceType === "Fee Concession") {
            const totalInput = row.children[6].querySelector("input");
            const totalVal = parseFloat(totalInput ? totalInput.value : 0) || 0;
            grandTotal += totalVal;
          } else {
            const qty = parseFloat(row.children[4].querySelector("input").value) || 0;
            const rate = parseFloat(row.children[5].querySelector("input").value) || 0;
            const total = qty * rate;
            row.children[6].textContent = total.toFixed(2);
            grandTotal += total;
          }
        });

        document.getElementById("grandTotal").textContent = `Total Amount: ‚Çπ${grandTotal.toFixed(2)}`;
        document.getElementById("amountInWords").textContent = `Total (in words): ${convertNumberToWords(grandTotal)} Only`;
        const paid = parseFloat(document.getElementById("amountPaid").value) || 0;
        const balance = grandTotal - paid;
        document.getElementById("dueBalance").textContent = `Due Balance: ‚Çπ${balance.toFixed(2)}`;
        updateQRCode(balance);
      }

      // --- convert number to words (basic Indian system) ---
      function convertNumberToWords(num) {
        if (!num || isNaN(num) || Number(num) === 0) return 'Zero Rupees';
        const a = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten',
                   'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen',
                   'Eighteen', 'Nineteen'];
        const b = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];

        const nnum = Math.floor(Math.abs(Number(num)));
        if (nnum.toString().length > 9) return 'Amount too high';
        const n = ('000000000' + nnum).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
        if (!n) return '';
        let str = '';
        str += (n[1] != 0) ? (a[Number(n[1])] || (b[n[1][0]] + ' ' + a[n[1][1]])) + ' Crore ' : '';
        str += (n[2] != 0) ? (a[Number(n[2])] || (b[n[2][0]] + ' ' + a[n[2][1]])) + ' Lakh ' : '';
        str += (n[3] != 0) ? (a[Number(n[3])] || (b[n[3][0]] + ' ' + a[n[3][1]])) + ' Thousand ' : '';
        str += (n[4] != 0) ? (a[Number(n[4])] || (b[n[4][0]] + ' ' + a[n[4][1]])) + ' Hundred ' : '';
        str += (n[5] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n[5])] || (b[n[5][0]] + ' ' + a[n[5][1]])) + ' ' : '';
        return (str.trim() + ' Rupees');
      }

      // --- build UPI QR with remaining balance amount ---
      function updateQRCode(amount) {
        const upiID = "9706380357@ucobank";
        const payeeName = "G10 EDUCATIONAL PLATFORM";
        const amt = (isNaN(amount) ? 0 : Number(amount).toFixed(2));
        const upiURL = `upi://pay?pa=${upiID}&pn=${encodeURIComponent(payeeName)}&am=${amt}&cu=INR`;
        const qrCanvas = document.getElementById("qrCanvas");
        qrCanvas.innerHTML = "";
        new QRCode(qrCanvas, {
          text: upiURL,
          width: 100,
          height: 100,
        });
      }

      // --- initial population & QR ---
      populateDropdowns();
      updateQRCode(0);
    </script>
  </div> <!-- End of container -->

  <div class="notes" style="margin-top: 30px; font-size: 10px;">
    <p><strong>Note:</strong></p>
    <ol style="padding-left: 20px;">
      <li>This is a computer-generated invoice; signature is not required.</li>
      <li>Fee once paid is not refundable.</li>
    </ol>
  </div>

  <script>
    function checkPassword() {
      const password = document.getElementById("passwordInput").value;
      const correctPassword = "7099050509"; // change if needed
      if (password === correctPassword) {
        document.getElementById("passwordScreen").style.display = "none";
        document.getElementById("protectedContent").style.display = "block";
      } else {
        alert("Incorrect password. Try again.");
      }
    }
  </script>
</body>
</html>
