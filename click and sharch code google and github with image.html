<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Question Solver ‚Äî All-in-One</title>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.css">
<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.js"></script>

<!-- MathJax -->
<script>
window.MathJax = {
  tex: { inlineMath: [['\\(','\\)'], ['$', '$']] },
  svg: { fontCache: 'global' }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

<style>
body { font-family: Arial, Helvetica, sans-serif; background:#f4f6f9; margin:0; padding:18px; color:#222; }
h2{margin:6px 0 18px;font-weight:600;color:#2c3e50;text-align:center}
.mode-toggle{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-bottom:14px}
.toggle-label{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:8px;background:#fff;cursor:pointer;box-shadow:0 1px 3px rgba(0,0,0,.06)}
input[type="file"], textarea, input[type="text"]{font-size:1rem;padding:10px;margin:10px 0;width:100%;max-width:420px;border-radius:8px;border:1px solid #d9e2ec;box-sizing:border-box}
textarea{min-height:110px;resize:vertical}
button{padding:10px 16px;border-radius:8px;border:0;background:#3498db;color:#fff;font-weight:600;cursor:pointer}
button:hover{background:#2c80b9}
.solution-box{background:#fff;border-radius:10px;padding:14px;margin-top:16px;box-shadow:0 6px 18px rgba(0,0,0,.06);text-align:left}
.solution-box img{max-width:100%;border-radius:8px}
.small{font-size:0.92rem;color:#555}
.hidden{display:none}
#cropModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:9999;align-items:center;justify-content:center;padding:18px}
#cropInner{max-width:100%;width:100%;max-width:900px;position:relative}
#cropImage{max-width:100%;max-height:75vh;border-radius:6px}
.modal-action{position:absolute;left:16px;bottom:18px;padding:10px 14px;border-radius:8px;background:#e74c3c;color:#fff;border:0;cursor:pointer}
.modal-action.confirm{right:16px;left:auto;background:#3498db}
#progressContainer{max-width:420px;margin:12px auto;display:none}
#progressWrapper{background:#e6eef8;border-radius:12px;overflow:hidden;height:18px}
#progressBar{height:18px;width:0%;transition:width .2s linear;background:#3498db}
.meta{margin-top:10px;font-size:0.95rem;color:#444}
.subject-label{display:inline-block;padding:6px 8px;background:#eef5fb;border-radius:6px;margin-bottom:8px}

/* Solution steps styling */
.solution-step-list{list-style:none;padding-left:0;margin-left:0;}
.solution-step-list li{background:#f0f4f8;padding:10px 12px;margin-bottom:8px;border-radius:6px;line-height:1.5;transition:box-shadow 0.25s ease, transform 0.2s ease;}
.solution-step-list li.step-numbered{background:#e8f0fc;cursor:default;}
.solution-step-list li.step-numbered:hover{box-shadow:0 4px 12px rgba(0,0,0,0.15); transform:translateY(-2px);}
.step-highlight { color:#f1c40f; font-weight:600; } /* Only Step X text yellow */
</style>
</head>
<body>
<div class="container">
<h2>üìö AI Question Solver ‚Äî (Physics | Chemistry | Math | Biology)</h2>

<div class="mode-toggle" role="tablist" aria-label="modes">
  <label class="toggle-label"><input type="radio" name="mode" value="image" checked> üì∑ Upload Image</label>
  <label class="toggle-label"><input type="radio" name="mode" value="text"> ‚úçÔ∏è Type Question</label>
  <label class="toggle-label"><input type="radio" name="mode" value="code"> üî¢ Enter Question Code</label>
</div>

<div id="imageMode"><input type="file" id="fileInput" accept="image/*" capture="environment"></div>
<div id="textMode" class="hidden">
  <textarea id="manualQuestion" placeholder="Type or paste your question here..."></textarea>
  <br><button id="solveManual">üîç Solve</button>
</div>
<div id="codeMode" class="hidden">
  <input type="text" id="questionCode" placeholder="Enter question code (eg. C101)">
  <br><button id="solveCode">üîç Get Answer</button>
</div>

<div id="cropModal" aria-hidden="true">
  <div id="cropInner">
    <img id="cropImage" alt="Crop preview">
    <button id="cancelCrop" class="modal-action">‚ùå Cancel</button>
    <button id="confirmCrop" class="modal-action confirm">‚úÇÔ∏è Crop & Solve</button>
  </div>
</div>

<div id="progressContainer">
  <div id="progressWrapper"><div id="progressBar"></div></div>
  <p id="progressText" class="small">Processing...</p>
</div>

<div class="solution-box" id="result">
  <div class="small">Select a mode and provide your question to see the solution.</div>
</div>
</div>

<script>
window.addEventListener('DOMContentLoaded',()=>{

const subjectUrls = {
  chemistry: "https://gten-educational-platform.github.io/Class-12/question.html",
  physics:   "https://gten-educational-platform.github.io/Class-12/physics.json",
  math:      "https://gten-educational-platform.github.io/Class-12/math.json",
  biology:   "https://gten-educational-platform.github.io/Class-12/biology.json"
};

let questionBanks={}, fuseBanks={}, cropper=null;

function cleanText(t){return t?String(t).replace(/\r\n/g,' ').replace(/\n/g,' ').replace(/\s+/g,' ').trim().toLowerCase():"";}
function removeNums(s){return String(s).replace(/\b\d+(\.\d+)?\b/g,'').replace(/\s+/g,' ').trim();}
function extractQText(q){if(!q)return""; if(typeof q==="string") return q; if(typeof q==="object"&&q.text) return q.text; return JSON.stringify(q);}
function buildFuse(subj,data){
  data.forEach(item=>{
    const qtxt=cleanText(extractQText(item.question));
    const stxt=(item.solution && item.solution.text)? cleanText(item.solution.text):"";
    const combined=`${qtxt} ${stxt} ${item.code?String(item.code).toLowerCase():''}`.trim();
    item._searchable=combined;
    item._searchable_no_nums=removeNums(combined);
  });
  fuseBanks[subj]=new Fuse(data,{keys:['_searchable_no_nums'],threshold:0.45,distance:200,includeScore:true,minMatchCharLength:3});
  fuseBanks[subj+"_nums"]=new Fuse(data,{keys:['_searchable'],threshold:0.55,distance:200,includeScore:true,minMatchCharLength:3});
  questionBanks[subj]=data;
}

async function loadSubjects(){
  for(const [subj,url] of Object.entries(subjectUrls)){
    if(!url) continue;
    try{
      const resp=await fetch(url);
      if(!resp.ok) continue;
      let data=await resp.json();
      if(!Array.isArray(data)) data=[data];
      buildFuse(subj,data);
    }catch(e){console.warn(`Failed to load ${subj}`,e);}
  }
}
loadSubjects();

function htmlEscape(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function renderContent(content,label){
  if(!content) return "";
  let html="";
  if(typeof content==="string"){
    if(content.match(/\.(jpeg|jpg|png|gif|svg)$/i)) html+=`<p><b>${label}:</b></p><img src="${htmlEscape(content)}" alt="${label}">`;
    else html+=`<p><b>${label}:</b> <span class="mathjax">${htmlEscape(content)}</span></p>`;
  }else if(typeof content==="object"){
    if(content.text) html+=`<p><b>${label}:</b> <span class="mathjax">${htmlEscape(content.text)}</span></p>`;
    if(content.image) html+=`<img src="${htmlEscape(content.image)}" alt="${label} image">`;
  }
  return html;
}

function renderQA(item,subj){
  let html=`<div class="subject-label">${subj.toUpperCase()}</div>`;
  if(item.code) html+=`<p><b>Code:</b> <span class="small">${htmlEscape(item.code)}</span></p>`;
  html+=renderContent(item.question,"Question");
  html+=renderContent(item.solution,"Solution");

  const steps = item.solution_steps || (item.solution && item.solution.solution_steps);
  if(steps && Array.isArray(steps)){
    html+=`<p><b>Solution Steps:</b></p><ul class="solution-step-list">`;
    steps.forEach(step=>{
      const isNumbered = /Step\s*\d+/i.test(step);
      const className = isNumbered ? 'step-numbered' : '';
      // Highlight only "Step X" text
      const stepHtml = htmlEscape(step).replace(/(Step\s*\d+)/ig,'<span class="step-highlight">$1</span>');
      html+=`<li class="${className}"><span class="mathjax">${stepHtml}</span></li>`;
    });
    html+=`</ul>`;
  }
  setTimeout(()=>{if(window.MathJax && MathJax.typeset) MathJax.typeset();},60);
  return html;
}

function searchSolution(rawText){
  const text=cleanText(rawText), textNoNums=removeNums(text);
  let allMatches=[];

  for(const subj in fuseBanks){
    if(subj.endsWith("_nums")) continue;
    try{ const r=fuseBanks[subj].search(textNoNums); if(r.length) r.forEach(m=>{if(m.score<0.8) allMatches.push({item:m.item,score:m.score,subj})}); }catch(e){}
  }
  for(const subj in fuseBanks){
    if(!subj.endsWith("_nums")) continue;
    try{ const r=fuseBanks[subj].search(text); if(r.length) r.forEach(m=>{if(m.score<0.8) allMatches.push({item:m.item,score:m.score,subj:subj.replace(/_nums$/,'')})}); }catch(e){}
  }

  if(allMatches.length){
    allMatches.sort((a,b)=>a.score-b.score);
    let html="";
    allMatches.slice(0,5).forEach(m=>{html+=renderQA(m.item,m.subj)+"<hr>";});
    return html;
  }
  try{window.open("https://www.google.com/search?q="+encodeURIComponent(rawText),"_blank");}catch(e){}
  return `‚ùå No match found. Searching Google...`;
}

function searchByCode(code){
  if(!code) return "‚ö†Ô∏è Please enter a code.";
  const lc=String(code).toLowerCase().trim();
  for(const subj in questionBanks){
    const bank=questionBanks[subj];
    if(!Array.isArray(bank)) continue;
    const match=bank.find(q=>q.code && String(q.code).toLowerCase()===lc);
    if(match) return renderQA(match,subj);
  }
  return "‚ùå No question found with this code.";
}

document.querySelectorAll("input[name='mode']").forEach(radio=>{
  radio.addEventListener('change',e=>{
    document.getElementById('imageMode').classList.toggle('hidden',e.target.value!=='image');
    document.getElementById('textMode').classList.toggle('hidden',e.target.value!=='text');
    document.getElementById('codeMode').classList.toggle('hidden',e.target.value!=='code');
  });
});

const fileInput=document.getElementById('fileInput'),
cropModal=document.getElementById('cropModal'),
cropImage=document.getElementById('cropImage'),
confirmCrop=document.getElementById('confirmCrop'),
cancelCrop=document.getElementById('cancelCrop'),
result=document.getElementById('result'),
progressContainer=document.getElementById('progressContainer'),
progressBar=document.getElementById('progressBar'),
progressText=document.getElementById('progressText'),
solveManual=document.getElementById('solveManual'),
manualQuestion=document.getElementById('manualQuestion'),
solveCode=document.getElementById('solveCode'),
questionCode=document.getElementById('questionCode');

fileInput.addEventListener('change',()=>{
  const file=fileInput.files[0];
  if(!file) return;
  cropImage.src=URL.createObjectURL(file);
  cropModal.style.display='flex';
  if(cropper) cropper.destroy();
  cropper=new Cropper(cropImage,{viewMode:1,autoCropArea:1,background:false,movable:true,zoomable:true,scalable:false,rotatable:false,dragMode:'move',minCropBoxWidth:50,minCropBoxHeight:50});
});

confirmCrop.addEventListener('click',()=>{
  if(!cropper) return;
  cropModal.style.display='none';
  progressContainer.style.display='block';
  progressBar.style.width='0%';
  progressText.textContent='Processing image...';
  cropper.getCroppedCanvas().toBlob(blob=>{
    Tesseract.recognize(blob,'eng',{
      logger:m=>{
        if(m.status==='recognizing text'){
          const pct=Math.round(m.progress*100);
          progressBar.style.width=pct+'%';
          progressText.textContent=`Reading text... ${pct}%`;
        }
      }
    }).then(({data:{text}})=>{
      progressContainer.style.display='none';
      result.innerHTML=`<b>Extracted:</b><br>${text}<br><br>${searchSolution(text)}`;
      MathJax.typeset();
      cropper.destroy(); cropper=null;
      fileInput.value='';
    }).catch(err=>{
      progressContainer.style.display='none';
      result.innerHTML=`‚ö†Ô∏è OCR failed. Try a clearer image or type the question. Error: ${err}`;
    });
  });
});

cancelCrop.addEventListener('click',()=>{
  cropModal.style.display='none';
  if(cropper){cropper.destroy();cropper=null;}
});

solveManual.addEventListener('click',()=>{
  const text=manualQuestion.value.trim();
  if(!text){result.innerHTML="‚ö†Ô∏è Please type a question first.";return;}
  if(/^[A-Za-z0-9_-]{2,20}$/.test(text)&&!text.includes(' ')){
    result.innerHTML=searchByCode(text);
  } else{
    result.innerHTML=`<b>Question:</b> ${text}<br><br>${searchSolution(text)}`;
  }
  MathJax.typeset();
});

solveCode.addEventListener('click',()=>{
  const code=questionCode.value.trim();
  if(!code){result.innerHTML="‚ö†Ô∏è Please enter a question code.";return;}
  result.innerHTML=searchByCode(code);
  MathJax.typeset();
});

});
</script>
</body>
</html>
